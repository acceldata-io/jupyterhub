import os
import shutil


def setup_streamlit():
    """jupyter-server-proxy configuration for Streamlit.

    Returns the configuration dict that tells jupyter-server-proxy how to
    launch and proxy a Streamlit application.  When the user clicks the
    Streamlit launcher icon in JupyterLab a new Streamlit process is started
    on a random port and proxied through the existing JupyterHub auth layer.
    """
    return {
        "command": [
            _get_streamlit_executable(),
            "run",
            _ensure_default_app(),
            "--server.port",
            "{port}",
            "--server.headless",
            "true",
            "--server.enableCORS",
            "false",
            "--server.enableXsrfProtection",
            "false",
            "--browser.gatherUsageStats",
            "false",
        ],
        "timeout": 60,
        "new_browser_tab": True,
        "launcher_entry": {
            "title": "Streamlit",
            "icon_path": os.path.join(os.path.dirname(__file__), "icon.svg"),
        },
    }


def _get_streamlit_executable():
    """Return the full path to the streamlit binary if found, else 'streamlit'."""
    return shutil.which("streamlit") or "streamlit"


def _ensure_default_app():
    """Create a starter Streamlit app if one does not already exist.

    The file is placed in the user's working directory so it shows up in the
    JupyterLab file browser and can be edited immediately.
    """
    default_path = os.path.join(os.getcwd(), "streamlit_app.py")
    if not os.path.exists(default_path):
        with open(default_path, "w") as f:
            f.write(_DEFAULT_APP)
    return default_path


_DEFAULT_APP = '''\
import streamlit as st

st.set_page_config(page_title="My Streamlit App", layout="wide")

st.title("Welcome to Streamlit")
st.markdown(
    """
    This is a starter Streamlit application running inside JupyterHub.

    Edit **streamlit_app.py** in JupyterLab to build your own app, or run
    any other script from the terminal:

    ```bash
    streamlit run my_other_app.py --server.port 0
    ```

    The app will be automatically proxied through JupyterHub â€” no extra
    port or authentication setup needed.
    """
)

name = st.text_input("What is your name?")
if name:
    st.write(f"Hello, {name}!")
'''
